---
title: "Documentation of the extension of the fisheries composition dataset"
author:
- "Lucia Segovia D L Revilla"
- "Thomas Codd"
- "Louise Ander"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document: default
  html_document: default
  word_document: default
editor_options:
  markdown:
    wrap: 72
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE)

library(gt)

```

## SUMMARY

**insert image (flowchart)**

1.  Identifying the data:

QC1: Evaluate the quality of the dataset and the documentation
accompanying the dataset.

2.  Importing the data into R: This step is going to depend on the
    original (raw) format.

QC2: We will ensure that all the data has been imported and done
correctly. E.g., check that total number of observations and variables
are correctly imported.

3.  Tidying the data: This means we will convert from the original (raw)
    format to a standardised (harmonised) format, by performing all or
    some of the following operations:

<!-- -->

a.  Variable names: Components will be name using Tagnames (upper case)
    and the standard unit (lower case) (e.g., PROTg).

b.  Dividing combined variables into two (or more) columns. E.g.,
    `CARTEB or [CARTEBEQ]` into `CARTEBmg`, `CARTBEQmg`.

c.  *Removing brackets* or other special characters ("[]", "()", "\*").
    E.g., extracting the numeric value from inside the bracket from "low
    quality"/alternative methods. --\> How can we record/ account for it
    within the data?

d.  *Removing summary stat from the table* --\> How can we keep/use that
    data?

e.  Food name/ description standardisation: For instance, for fisheries
    [ASFIS codes](https://www.fao.org/fishery/en/collection/asfis/en)
    will be assigned according to their species and fishery products.

f.  Food groups variable (row to column).

QC3: Check that observations and variables are still the same as the
original dataset, or in line with the previous operations performed, for
instance, if we have divided a column into two, our dataset should have
the same number of variables plus one.

4.  Data transformation: Changes to the original data values will be
    performed and documented.

<!-- -->

a.  Changing characters into numeric. For example, trace ("tr") or below
    detection limit ("\<LOD") will be converted into zero (0).

b.  Changing variable units. For example from mg to g, according to the
    standard reporting units (FAO/INFOODS, 2013).

c.  Combining or Re-calculating variables: Summary statistics will be
    calculated for each FAO ICP codes. For example, energy needs to be
    calculated from other components.

<!-- -->

5.  Visualising the data: missing values and outliers will be plotted
    and identified.

6.  Exporting data and metadata

## Background

**complete this w/ info from the contract and report**

##### Components that we need to collect information for:

1.  Iodine - excluded
2.  Se - included
3.  Cu - included
4.  Na? - excluded
5.  Niacin (Vit. B3) - included, if we are calculating NIATRP, we need
    TRP too.
6.  Vit. B6 - included, VITB6A = from analysis, VITB6C = calculated, and
    VITB6-.
7.  Vit. B12 - included
8.  Vit. D - excluded (including D3, D2 and hidroxi forms).
9.  PUFA - DHA (22:6 (n-3)) - included\
10. PUFA - EPA (20:5 (n-3)) - included

### 1. Preparation steps: Identifying the data

#### 1. 1. Reviewing FCTs of the current version of the Fisheries Global NCT 

Of the 13 FCTs included in the Global Table of Nutrient Values, for the
Fisheries Global NCT, 2022 (FISHERIES-GlobalNCT_ForSharing_Feb2022.xls),
uPulses FCTs was excluded because data was not relevant for fisheries,
i.e., only reported pulses. Then, three FCTs were not publicly available
and, we requested access to the FAO Team. Access was granted and was
covered by the data sharing agreement.

Then, we reviewed the availability of ten pre-selected food components
(Copper, (Cu), Iodine (I), Selenium (Se), Vitamin B6 (Vit. B6), Vitamin
B12 (Vit. B12), Vitamin D (Vit. D), Niacin, (DHA), (EPA)) in the 12
FCTs. Some data gaps were found for those components in the previously
reviewed FCTs, hence we reviewed other possible sources of nutrient
values (e.g. The Norwegian FCDB, 2021).

Because most of the FCTs included were previously reviewed by the FAO
team, there was no need of checking the overall quality of the other
FCTs.

#### 1. 2. Identifying new potential sources of NVs 

We reviewed some FCTs that could provide information on fish and fishery
products for the pre-defined nutrients of interest. Some potential
candidates were FCTs of countries or region with potentially high
consumption of fish: Ciqual FCDB (France), 2019, Norway FCDB, 2021,
ASEAN FCDB, 2014.

When assessing quality and availability of data, we used the FAO/INFOODS
framework (screening questions) to identify potential source of nutrient
values. This led to the inclusion of the Norwegian FCDB, 2021. Because,
it was the only new FCDB included which was not previously reviewed by
the FAO team, we checked the original values of the Norwegian FCDB, 2021
(NO21) in depth, which is discussed in the **Section 2.1** of the
protocol of the NO21 (NO21_docu.Rmd).

In table 1, we can find information on the final list of FCDBs included.

\*\*Table 1.\* List of all the FCTs included, and description of their
access, format and reviewing team.

| BiblioID   | Reference                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | Link to access original data                                                                | Access                                                                                     |       Format       | Reviewer |
|------------|-------------|------------|------------|:----------:|------------|
| US19       | US Department of Agriculture (USDA), Agricultural Research Service, Nutrient Data Laboratory. USDA National Nutrient Database for Standard Reference, Legacy. Version Current: April 2019.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | <http://www.ars.usda.gov/nutrientdata>                                                      | Publicly available                                                                         |       Access       | FAO      |
| AU19       | Food Standards Australia New Zealand (FSANZ). 2019. The Australian Food Composition Database, release 1 \\[online\\]. Canberra.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | <http://www.foodstandards.gov.au>                                                           | Internal                                                                                   |       excel        | FAO      |
| NZ18       | New Zealand Food Composition Database. 2019. New Zealand FOODfilesTM 2018 Manual. The New Zealand Institute for Plant and Food Research Limited and Ministry of Health.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | <http://www.foodcomposition.co.nz/foodfiles>                                                | Publicly available                                                                         |       excel        | FAO      |
| UK21       | Food Standards Agency. 2021. McCance and Widdowson's The Composition of Foods Integrated Dataset (CoFID) 2021. London, Institute of Food Research, Public Health England.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                                                                                             | <https://www.gov.uk/government/publications/composition-of-foods-integrated-dataset-cofid> | publicly available | excel    |
| DK19       | Frida, DTU Foods public food database, version 4, 2019, National Food Institute, Technical University of Denmark.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | <https://frida.fooddata.dk>                                                                 | Publicly available                                                                         |       excel        | FAO      |
| WA19       | Vincent, A., Grande, F., Compaoré, E., Amponsah Annor, G., Addy, P.A., Aburime, L.C., Ahmed, D., Bih Loh, A.M., Dahdouh Cabia, S., Deflache, N., Dembélé, F.M., Dieudonné, B., Edwige, O.B., Ene-Obong, H.N., Fanou Fogny, N., Ferreira, M., Omaghomi Jemide, J., Kouebou, P.C., Muller, C., Nájera Espinosa, S., Ouattara, F., Rittenschober, D., Schönfeldt, H., Stadlmayr, B., van Deventer, M., Razikou Yiagnigni, A. & Charrondière, U.R. 2020. FAO/INFOODS Food Composition Table for Western Africa (2019) User Guide & Condensed Food Composition Table / Table de composition des aliments FAO/INFOODS pour l'Afrique de l'Ouest (2019) Guide d'utilisation & table de composition des aliments condensée. Rome, FAO. | <https://www.fao.org/fileadmin/user_upload/faoweb/2020/WAFCT_2019.xlsx>                     | Publicly available                                                                         |       excel        | FAO      |
| KE18       | FAO & Government of Kenya. 2018. Kenya Food Composition Tables [online]. Nairobi.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | <http://www.kilimo.go.ke/wp-content/uploads/2018/10/KENYA-FOOD-COMPOSITION-TABLES-2018.pdf> | Publicly available                                                                         |       excel        | FAO      |
| IN17       | Longvah, T., Ananthan, R., Bhaskarachary, K. & Venkaiah, K. 2017. Indian Food Composition Tables. Hyderabad, India, National Institute of Nutrition.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | <http://www.ifct2017.com/frame.php?page=home>                                               | Internal                                                                                   |       excel        | FAO      |
| JA15       | MEXT. (2015).The Standard Tables of Food Composition in Japan 2015 (Seventh Revised Edition). Official Gazette Co-operation of Japan. Japan                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | <http://www.mext.go.jp/a_menu/syokuhinseibun/1365451.htm/>                                  | Publicly available                                                                         |       excel        | FAO      |
| BA13       | Shaheen N., Rahim A.T.M.A., Mohiduzzaman Md., Banu C.P., Bari Md. L., Tukun A.B., Mannan M.A., Bhattacharjee L., Stadlmayr B. 2013. Food Composition Table for Bangladesh. Institute of Nutrition and Food Science, Centre for Advanced Research in Sciences, University of Dhaka.                                                                                                                                                                                                                                                                                                                                                                                                                                             | <https://www.fao.org/fileadmin/templates/food_composition/documents/FCDB_7_4_14.xlsx>       | Publicly available                                                                         |       excel        | FAO      |
| BR11       | Nucleo de Estudos e pesquisas em Alimentacao (NEPA). Brazilian Food Composition Table (TACO), 4th ed., 2011.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | <https://www.nepa.unicamp.br/taco/tabela.php?ativo=tabela>                                  | Internal                                                                                   |       excel        | FAO      |
| UF16       | FAO. 2016. FAO/INFOODS Global Food Composition Database for Fish and Shellfish. Version 1.0 -- uFiSh1.0. Rome.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | <http://www.fao.org/infoods/infoods/tables-and-databases/faoinfoods-databases/en/>).        | Publicly available                                                                         |       excel        | FAO      |
| UP17 [\^1] | FAO. 2017. FAO/INFOODS Global Food Composition Database for Pulses. Version 1.0 -- uPulses 1.0. Rome.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | <http://www.fao.org/infoods/infoods/tables-and-databases/faoinfoods-databases/en/>).        | Publicly available                                                                         |       excel        | FAO      |
| NO21       | Norwegian Food Composition Database 2021. Norwegian Food Safety Authority.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | <https://www.matportalen.no/verktoy/the_norwegian_food_composition_table/>                  | Publicly available                                                                         |       excel        | UoN      |

[\^1]Note: UP17 was not process because we were only interested in fish.

## Harmonisation of the food composition tables and databases (method)

The harmonisation required two main steps: importing (loading) databases
into R and cleaning and standardising the databases.

### 1. Importing the data

Datasets were found in a variety of formats that needed to be imported
and cleaned into a tabular format. E.g. one row per food entry and one
column per variable (food entry attribute).

The steps and scripts for importing each FCDB are stored together with
the original FCT (raw files) in individual folders named with the
BiblioID (See table 1) which is stored in the variable `source_fct` (See
table 2).

### 2. Tidying the data 

In order to merge all data from various FCTs we needed to harmonise the
information in each dataset. The steps that were taken are explained
below and annotated scripts for each FCTs can be found in this
repository in each corresponding folder.

#### 2.1. Renaming variable names 

Each FCT has its own variable names, including for nutrient values. Some
FCTs included information related to the FAO/ INFOODS food components
identifiers
[(Tagnames)](https://www.fao.org/infoods/infoods/standards-guidelines/food-component-identifiers-tagnames/en/)

while other did not. In order to merge all data from various FCDBs we
need to harmonise the names of all the variables and particularly the
food components of interest. To do so, we evaluated and renamed them
with the most appropriate Tagname. Other variables (e.g., food id, food
name or food description) were renamed to a common variable name, for
instance, `fdc_id`, `food_desc`, following the variable names used in
the Fisheries Global NCT file.

**The identification of food components**

Information on the food components and their description should be
sought in each FCT included. We are reviewing the Tagnames used in the
previous version for generating the same structure and format in our
output table. Some minor changes in the variables names were introduced
to be compliant with R conventions. E.g., removing spaces in variables
names, changing symbols to characteres (e.g., µg to mcg), or
standardising the name formatting from using underscores and/or
parenthesis to using only underscores. Also, changing dashes (-) to
underscores (-). Note that within the Tagnames, the dash is used to
denote that the method for obtaining that (component) value is unknown.
This is important for the quality assessment of the data.

Also, we also assumed that all the variables labelled as "standardised"
were combined or recalculated variables

Table 2 provides a list of all the variables including components used
in the previous version of the Fisheries Global NCT.

**Table 2.**: List of variables names (including Tagnames), description
and reference for the Tagnames.

| Variable name                                                        | Description                                                                                                                                                                                                                                                                                                                                                 | Reference                               |
|------------------|-------------------------------------|------------------|
| fdc_id                                                               | food identifier as per original source (FCT)                                                                                                                                                                                                                                                                                                                | \-                                      |
| food_desc                                                            | food name and description as per original source (FCT)                                                                                                                                                                                                                                                                                                      | \-                                      |
| food_group                                                           | food group as per original source (FCT)                                                                                                                                                                                                                                                                                                                     | \-                                      |
| scientific_name                                                      | Scientific name of the food                                                                                                                                                                                                                                                                                                                                 | \-                                      |
| source_fct                                                           | Id. of the FCT (BiblioID), see Table 1                                                                                                                                                                                                                                                                                                                      | \-                                      |
| nutrient_data_source                                                 | references or data source for the nutrient values                                                                                                                                                                                                                                                                                                           | \-                                      |
| Edible_factor_in_FCT                                                 | edible portion reported as fraction edible, imputed from the original FCT, or calculated from refuse in the FCT                                                                                                                                                                                                                                             | \-                                      |
| Edible_desc                                                          | information provided on the edible portion                                                                                                                                                                                                                                                                                                                  | \-                                      |
| specific_gravity                                                     | density reported in the original units as in the origianl FCT                                                                                                                                                                                                                                                                                               | \-                                      |
| SOPg                                                                 | Sum of Proximate in g per 100g EP as reported in the original FCT                                                                                                                                                                                                                                                                                           | \-                                      |
| ASHg                                                                 | Ashes in g per 100g of EP                                                                                                                                                                                                                                                                                                                                   | \-                                      |
| ENERCkJ                                                              | Energy in kJ/ 100g of EP as reported in the original FCT                                                                                                                                                                                                                                                                                                    | \-                                      |
| ENERCkcal                                                            | Energy in kcal/ 100g EP as reported in the original FCT                                                                                                                                                                                                                                                                                                     | \-                                      |
| WATERg                                                               | Water/ moisture content in g per 100g of EP                                                                                                                                                                                                                                                                                                                 | \-                                      |
| PROCNTg                                                              | protein in g per 100g of EP, as reported in the original FCT and assumed to be calculated from nitrogen (NTg) content                                                                                                                                                                                                                                       | FAO/INFOODS, 2012                       |
| NTg                                                                  | Nitrogen, total                                                                                                                                                                                                                                                                                                                                             | FAO/INFOODS, 2012                       |
| XN                                                                   | Nitrogen conversion factor                                                                                                                                                                                                                                                                                                                                  | FAO/INFOODS, 2012                       |
| FATg                                                                 | total fat content in g per 100g of EP. Sum of triglycerides, phospholipids, sterols and related compounds obtained by a mixed solvent extraction                                                                                                                                                                                                            | FAO/INFOODS, 2012                       |
| FAT_g                                                                | fat content unknown method of calculation in g per 100g of EP                                                                                                                                                                                                                                                                                               | \-                                      |
| FATCEg                                                               | fat content measured using continuous extraction (e.g., Soxhlet method) expressed in g per 100g of EP                                                                                                                                                                                                                                                       | FAO/INFOODS, 2012                       |
| CHOAVLDFg                                                            | available carbohydrates calculated by difference (E.g., 100 - (weight in grams of water + protein + fat + ash + fibre + alcohol in 100 g of food)) imputed from the original source                                                                                                                                                                         | FAO/INFOODS, 2012                       |
| CHOAVLg                                                              | available carbohydrates calculated by weight in g per 100g of EP                                                                                                                                                                                                                                                                                            | FAO/INFOODS, 2012                       |
| CHOCSMg                                                              | carbohydrates, total; calculated by summation. This values is the sum of the sugars, starches, oligosaccharide, and dietary fibre in g per 100g of EP                                                                                                                                                                                                       | FAO/INFOODS, 2012                       |
| CHOAVLMg                                                             | carbohydrates, available in monosaccharide equivalent. This value includes the free sugars plus dextrins, starch, and glycogen in g per 100g of EP                                                                                                                                                                                                          | FAO/INFOODS, 2012                       |
| FIBTGg                                                               | total dietary fibre by AOAC Prosky method expressed in g per 100g of EP                                                                                                                                                                                                                                                                                     | FAO/INFOODS, 2012                       |
| NSPg                                                                 | non-starch polysaccharide, (Englyst fibre) expressed in g per 100g of EP                                                                                                                                                                                                                                                                                    | FAO/INFOODS, 2012                       |
| FIBCg                                                                | fibre, crude in g per 100g of EP                                                                                                                                                                                                                                                                                                                            | FAO/INFOODS, 2012                       |
| ALCg                                                                 | alcohol in g per 100g                                                                                                                                                                                                                                                                                                                                       | \-                                      |
| ALCg_100mL                                                           | alcohol expressed in g per 100mL                                                                                                                                                                                                                                                                                                                            | \-                                      |
| SUGARg                                                               | total sugar (the sum of free mono- and disaccharides) in g per 100g of EP                                                                                                                                                                                                                                                                                   | \-                                      |
| FASATg                                                               | fatty acids, total saturated in g per 100g                                                                                                                                                                                                                                                                                                                  | FAO/INFOODS, 2012                       |
| FAMSg                                                                | fatty acids, total monounsaturated in g per 100g                                                                                                                                                                                                                                                                                                            | FAO/INFOODS, 2012                       |
| FAPUg                                                                | fatty acids, total polyunsaturated in g per 100g of EP                                                                                                                                                                                                                                                                                                      | FAO/INFOODS, 2012                       |
| FATRNg                                                               | fatty acids, total trans in g per 100g EP                                                                                                                                                                                                                                                                                                                   | FAO/INFOODS, 2012                       |
| F22D6N3g                                                             | docosahexaenoic acid (DHA) (22:6 n-3) in g/100g of EP                                                                                                                                                                                                                                                                                                       | \-                                      |
| F20D5N3g                                                             | eicosapentaenoic acid (EPA) (20:5 n-3) in g/100g of EP                                                                                                                                                                                                                                                                                                      | \-                                      |
| CHOLEmg                                                              | cholesterol determined by enzymatic or chromatographic method in mg per 100g of EP                                                                                                                                                                                                                                                                          | \-                                      |
| CHOL_mg                                                              | cholesterol by unknown method of determination in mg per 100g of EP                                                                                                                                                                                                                                                                                         | \-                                      |
| RETOLmcg                                                             | retinol in mcg per 100g of EP                                                                                                                                                                                                                                                                                                                               | \-                                      |
| VITAmcg                                                              | Vitamin A (Retinol Eq. (RE) = mcg retinol + 1/6 mcg ß- carotene + 1/12 mcg other pro-vitamin A carotenoids) in mcg per 100g of EP                                                                                                                                                                                                                           | FAO/INFOODS, 2012                       |
| VITA_RAEmcg                                                          | Vitamin A (Retinol Activity Eq. (RAE) = mcg retinol + 1/12 mcg ß- carotene + 1/24 mcg other provitamin A carotenoids) in mcg per 100g of EP                                                                                                                                                                                                                 | FAO/INFOODS, 2012                       |
| CARTBEQmcg                                                           | beta-carotene equivalents, is the sum of the beta-carotene + 1/2 quantity of other carotenoids with vitamin A activity, expressed in mcg per 100g of EP                                                                                                                                                                                                     | FAO/INFOODS, 2012                       |
| CARTAmcg                                                             | alpha-carotene in mcg per 100g of EP                                                                                                                                                                                                                                                                                                                        | FAO/INFOODS, 2012                       |
| CARTBmcg                                                             | beta-carotene in mcg per 100g of EP                                                                                                                                                                                                                                                                                                                         | FAO/INFOODS, 2012                       |
| CRYPXBmcg                                                            | beta-cryptoxanthin in mcg per 100g of EP                                                                                                                                                                                                                                                                                                                    | FAO/INFOODS, 2012                       |
| VITEmg                                                               | vitamin E calculated by summation of the vitamin E activities of the active tocopherols and tocotrienols expressed as alpha-tocopherol equivalent in mg per 100g of EP (alpha-tocophero eq. = alpha-tocopherol + 0.4 beta-tocopherol + 0.1 gamma-tocopherol+ 0.01 delta-tocopherol+ 0.3 alpha-tocotrienol + 0.05 beta-tocotrienol + 0.01 gamma-tocotrienol) | FAO/INFOODS, 2012                       |
| TOCPHAmg                                                             | alpha-tocopherol in mg per 100g of EP                                                                                                                                                                                                                                                                                                                       | Tagnames, 2007 (accessed on 2022-06-08) |
| TOCPHBmg                                                             | beta-tocopherol in mg per 100g of EP                                                                                                                                                                                                                                                                                                                        | Tagnames, 2007 (accessed on 2022-06-08) |
| TOCPHGmg                                                             | gamma-tocopherol in mg per 100g of EP                                                                                                                                                                                                                                                                                                                       | Tagnames, 2007 (accessed on 2022-06-08) |
| TOCPHDmg                                                             | delta-tocopherol in mg per 100g of EP                                                                                                                                                                                                                                                                                                                       | Tagnames, 2007 (accessed on 2022-06-08) |
| TOCTRAmg                                                             | alpha-tocotrienol in mg per 100g of EP                                                                                                                                                                                                                                                                                                                      | Tagnames, 2007 (accessed on 2022-06-08) |
| TOCTRBmg                                                             | beta-tocotrienol in mg per 100g of EP                                                                                                                                                                                                                                                                                                                       | Tagnames, 2007 (accessed on 2022-06-08) |
| TOCTRGmg                                                             | gamma-tocotrienol in mg per 100g of EP                                                                                                                                                                                                                                                                                                                      | Tagnames, 2007 (accessed on 2022-06-08) |
| THIAmg                                                               | thiamin, vitamin B1 analysed and expressed as thiamin in mg per 100g of EP                                                                                                                                                                                                                                                                                  | FAO/INFOODS, 2013b                      |
| THIAHCLmg                                                            | thiamin hydrochloride, vitamin B1 analysed and expressed as thiamin hydrochloride in mg per 100g of EP                                                                                                                                                                                                                                                      | FAO/INFOODS, 2013b                      |
| RIBFmg                                                               | Riboflavin (Vitamin B2) in mg per 100g of EP                                                                                                                                                                                                                                                                                                                | Tagnames, 2007 (accessed on 2022-06-08) |
| VITB6Amg                                                             | Vitamin B6 determined by analysis in mg/100g of EP                                                                                                                                                                                                                                                                                                          | FAO/INFOODS, 2012                       |
| VITB6Cmg                                                             | Vitamin B6 determined by calculation (sum of pyridoxal, pyridoxamine and pyridoxine) in mg per 100g EP                                                                                                                                                                                                                                                      | FAO/INFOODS, 2012                       |
| VITB6_mg                                                             | Vitamin B6 by unknown method in mg/100g of EP                                                                                                                                                                                                                                                                                                               | Tagnames, 2007 (accessed on 2022-06-08) |
| FOLDFEmcg                                                            | dietary folate equivalents calculated as food folate + 1.7 x synthetic folic acid and expressed in mcg per 100g of EP                                                                                                                                                                                                                                       | FAO/INFOODS, 2012                       |
| FOLmcg                                                               | folate, total (food folate + synthetic folic) in mcg per 100g EP. Includes both conjugated and free folate (determined by microbiological assay)                                                                                                                                                                                                            | FAO/INFOODS, 2012                       |
| FOLACmcg                                                             | folic acid. Synthetic folic acid used in fortification and expressed in mcg per 100g EP                                                                                                                                                                                                                                                                     | FAO/INFOODS, 2012                       |
| FOLFDmcg                                                             | folate food, naturally occurring food folate (determined by microbiological assay) in mcg per 100g EP                                                                                                                                                                                                                                                       | FAO/INFOODS, 2012                       |
| FOLSUMmcg                                                            | folate, sum vitamers in mcg per 100g EP. It includes mostly tetrahydrofolate, 5-methyltetrahydrofolate, 5-formyltetrahydrofolate, 10-formylfolic acid, 10-formyldihyrdofolate and folic acid (determined by HPLC)                                                                                                                                           |                                         |
| FOL_mcg                                                              | folate total, unknown method                                                                                                                                                                                                                                                                                                                                | Fisheries Global NCT, 2022              |
| NIAEQmg                                                              | niacin equivalents, total. Preformed niacin plus niacin equivalents from tryptophan (TRP) in mg per 100g EP                                                                                                                                                                                                                                                 | FAO/INFOODS, 2012                       |
| NIAmg                                                                | Niacin, prefrormed in mg per 100g EP                                                                                                                                                                                                                                                                                                                        | FAO/INFOODS, 2012                       |
| NIATRPmg                                                             | niacin equivalents, from tryptophan. 1/60 x tryptophan (TRP) expressed in mg per 100g EP                                                                                                                                                                                                                                                                    | FAO/INFOODS, 2012                       |
| TRPmg = tryptophan in mg per 100g of EP (includes only L-tryptophan) | Tagnames, 2007 (accessed on 2022-06-08)                                                                                                                                                                                                                                                                                                                     |                                         |
| VITB12mcg                                                            | Vitamin B12 (cobalamin, including all the active forms in foods) expressed in mcg per 100g EP                                                                                                                                                                                                                                                               | Tagnames, 2007 (accessed on 2022-06-08) |
| VITCmg                                                               | vitamin C (L-ascorbic acid plus Ldehydro-ascorbic acid). Usually analyzed by HPLC and expressed in mg per 100g of EP                                                                                                                                                                                                                                        | FAO/INFOODS, 2012                       |
| ASCLmg                                                               | L-ascorbic acid in mg per 100g of EP. Titrimetry can normally analyze L-ascorbic acid only                                                                                                                                                                                                                                                                  | FAO/INFOODS, 2012                       |
| VITDEQmcg                                                            | vitamin D calculated as the sum of Vitamin D3 + D2 + 5 x 25-hydroxycholecalciferol and expressed in mcg per 100g of EP                                                                                                                                                                                                                                      | FAO/INFOODS, 2012                       |
| VITDmcg                                                              | vitamin D calculated by summation of ergocalciferol and cholecalciferol and expressed in mcg per 100g of EP. This definition is mostly used                                                                                                                                                                                                                 | FAO/INFOODS, 2012                       |
| CHOCALmcg                                                            | cholecalciferol (D3) in mcg per 100g of EP                                                                                                                                                                                                                                                                                                                  | FAO/INFOODS, 2012                       |
| ERGCALmcg                                                            | ergocalciferol (D2) in mcg per 100g of EP                                                                                                                                                                                                                                                                                                                   | FAO/INFOODS, 2012                       |
| CHOCALOHmcg                                                          | 25-hydroxycholecalciferol in mcg per 100g of EP                                                                                                                                                                                                                                                                                                             | FAO/INFOODS, 2012                       |
| ERGCALOHmcg                                                          | 25-hydroxyergocalciferol                                                                                                                                                                                                                                                                                                                                    | Own definition based on CHOCALOHmcg     |
| CAmg                                                                 | calcium in mg per 100g of EP                                                                                                                                                                                                                                                                                                                                | Tagnames, 2007 (accessed on 2022-06-08) |
| MGmg                                                                 | magnesium in mg per 100g of EP                                                                                                                                                                                                                                                                                                                              | Tagnames, 2007 (accessed on 2022-06-08) |
| MNmg                                                                 | manganese in mg per 100g of EP                                                                                                                                                                                                                                                                                                                              | Tagnames, 2007 (accessed on 2022-06-08) |
| Pmg                                                                  | phosphorus in mg per 100g of EP                                                                                                                                                                                                                                                                                                                             | Tagnames, 2007 (accessed on 2022-06-08) |
| FEmg                                                                 | iron in mg per 100g of EP                                                                                                                                                                                                                                                                                                                                   | Tagnames, 2007 (accessed on 2022-06-08) |
| NAmg                                                                 | sodium in mg per 100g of EP                                                                                                                                                                                                                                                                                                                                 | Tagnames, 2007 (accessed on 2022-06-08) |
| Kmg                                                                  | potassium in mg per 100g of EP                                                                                                                                                                                                                                                                                                                              | Tagnames, 2007 (accessed on 2022-06-08) |
| CUmg                                                                 | copper in mg per 100g of EP                                                                                                                                                                                                                                                                                                                                 | Tagnames, 2007 (accessed on 2022-06-08) |
| ZNmg                                                                 | Zinc in mg per 100g of EP                                                                                                                                                                                                                                                                                                                                   | Tagnames, 2007 (accessed on 2022-06-08) |
| SEmcg                                                                | selenium in mcg per 100g of EP                                                                                                                                                                                                                                                                                                                              | Tagnames, 2007 (accessed on 2022-06-08) |
| IDmcg                                                                | iodine in mcg per 100g of EP                                                                                                                                                                                                                                                                                                                                | Tagnames, 2007 (accessed on 2022-06-08) |

#### 2.2. Other tidying operations <br>

**a. Diving combined variables into two (or more) columns.** For
example, when two components (Tagnames) were reported in the same column
and identified using brackets ([]) around the component values.
(`CARTEB or [CARTEBEQ]`) were separated into two independent columns and
bracket removed (`CARTEBmg`, `CARTBEQmg`).

**b. Removing brackets or other special characters ("[]", "()", "\*")**.
Similarly, special character were used to denote "low quality values"
and/or alternative (determination) methods. For those cases, the numeric
value was extracted and the special character removed. For future
development, a way of keeping that information should be found (e.g, how
can we record and account for those low quality values within the
dataset?, can we generate a score with the number of "low quality"
values per food item?).

**c. Removing summary statistics from the table.** Because summary
statistics will not be used, data were removed. For future development,
a way to account for variability (e.g., using the summary stats) could
be studied (How can we keep/use that data?, could we use them to account
for uncertainty in the final results?).

**d. Food name/ description standardisation.** The ASFIS list was used
for identification of the fish and fishery products. The ISSCAAP and the
3-alpha codes were assigned to fishery products for identification and
name standardisation. The ISSCAAP codes were also used for assigning the
FAO ICP code. The FAO ICP code were extracted from previous work
reported in Fisheries Global NCT, 2022, except for NO21 which was done
semi-manually using R scripts (`NO21/NO21.R`) and it is reported in
(`NO21/NO21_docu.Rmd`).

**e. Food groups variable.** Some food composition tables reported food
groups that were placed as the first row of each category. Those rows
were extracted and allocated as a new attribute of each food/fish entry
(i.e., from row to new column (`food_group`)).

### 3. Data transformation

Some variables needed more than just renaming to allow comparison.

#### 3.1. Changing characters into numeric <br>

To perform mathematical operations, characters needed to be converted
into numeric operator. For instance, values that were reported to be
trace ("tr") or below the detection limit ("\<LOD") were converted to
zero (0).

#### 3.2. Changing variable units <br>

To standardise and merge the different FCTs, components needs to be
reported in the same units. For example, some nutrients needed to be
convert from mg to g, or from percentage (100%) to a fraction (1). For
all the unit conversion we followed the FAO/INFOODS Guidelines for
Converting Units, Denominators and Expression (FAO/INFOODS, 2012b), and
the suggested standard reporting units.

Eg. Converting alcohol from weight in volumen (w/v) to weight in mass.

**Eq.1** ALC (g/100mL) / density (g/mL) = ALC (g/100 EP)

Eg. amino acids (AA) reported per g in 100g of PROT to mg in 100g of EP:

**Eq.2.1** AA mg/100g EP = AA mg/g prot \* prot g/100g EP /100

**Eq.2.2** AA mg/100g EP = AA g/ 100g prot \* prot g/100g EP /100 \*
1000/100

**Eq.2.3** AA mg/100g EP = AA g/100g prot \* prot g/100g EP /10

#### 3.3. Re-calculating variables <br>

For example Energy needs to be calculated from other components or
edible portion from refuse.

**Eq.3.1** Edible = 100-Refuse(%)/100

**Eq.3.2** Edible = 1-Refuse

#### 3.4. Combining Tagnames <br>

Some components could be reported using more than one Tagnames (as
described in the renaming section and table 2). Of the fish-relevant
nutrients selected for review some could be expressed using different
Tagnames, depending on: the fraction analysed (e.g., Vitamin D3, Vitamin
D2), or the method of analysis (e.g., VITB6A, VITB6C). When possible,
they were standardised by combining values from similar Tagnames such as
Vitamin B6 into a `_standardised` variable.

##### Generating functions for data transformation <br>

**Special values**: We generated a function (`no_brackets_tr`) to be
called to change trace and below the detection limit values to zero, and
to remove brackets (see functions.R).

**Combining variables**: `VITB6_mg_standardised` and
`FAT_g_standardised` variables were generated by using a function.

## Updating the Global Fish NCT

Once the FCTs were loaded and harmonised, we combined them into a single
data file, filter the fish entries and merged with the information
already provided by the FAO team regarding each fish entry ISSCAAP, ICS
FAOSTAT and alpha-three codes.

For this particular case the steps 3.4 and 3.4 were performed after
merging all the datasets together.

All the steps are done and documented in the `merging_all.R` script.

#### Checking Tagnames for completeness <br>

#### Checking quality of the values <br>

# Results

### 1. Importing FCTs

We extracted information on all the components available in the 13 FCTs,
however more attention have been given to the following: Cu, I, Se, Vit.
B6, Vit. B12, Vit. D, Niacin, DHA, EPA.

### 2. Tidying the data

#### 2.1. Renaming variables 

Checking food component names and renaming them with Tagnames

Some FCTs reported the Tagnames which were extracted and used to rename
the variables. The Tagnames were found in different formats.

-   In the AU19, it was expressed as part of the variable name.
    "Moisture (water) (WATER) (g)", being the Tagname `WATERg`.

-   Similarly, in the IN17 which was obtained from the sharing agreement
    with the FAO team, the Tagnames were available in the FCT and
    complemented with the FCT documentation [REF]. Note that a great
    number of organic acids were reported (Table 9, from column 123), of
    which very few Tagnames were available.

-   In the JA15, Tagnames were also self-contained in original FCT file.
    However, manual renaming of some components, as it was done for the
    IN17, was needed. For instance, "Protein, calculated from reference
    nitrogen_g" to `PROCNTg`, "Lipid_g" to `FATg`, and "Carbohydrate,
    total, calculated by difference_g" to `CHOAVLDFg`.

-   In KE18, Tagnames were also self-contained in the original database
    and also have been previously reviewed for the MAPS project. Only
    small fixes were needed to be adapted for this project (i.e., adding
    the units along the Tagnames or filtering columns that were mostly
    empty (FA)).

-   In WA19, Tagnames were provided and, as for KE18, has been
    previously reviewed and pre-processed for MAPS. Note that the edible
    portion is divided into two variables: "EDIBLE1" and "EDIBLE2", we
    are using "EDIBLE1" as the `Edible_factor_in_FCT` variable following
    FAO Fisheries Global NCT, 2022.

-   In BR11, Tagnames were provided by the FAO team as it was previously
    processed. Hence, only renaming of the information variables (e.g.,
    "food id" = fdc_id) was needed.

-   In UF16, it included Taganames and we only needed to rename "Edible
    coefficient, from whole to fillet/flesh (EDIBLE1)" to
    `Edible_factor_in_FCT`, following what was reported in the FAO
    Fisheries Global NCT, 2022,and as it was done in WA19.

For others datasets included, Tagnames were not reported and they needed
to be generated using the information reported in the Fisheries Global
NCT, 2022, and the documentation accompanying each FCT.

-   In the DK19 documentation
    [REF](https://frida.fooddata.dk/pdf/en-frida-2-introduction_20-12-2016-esax.pdf),
    we found that the variable named as "vitamin A (RE)" was in reality
    the Vitamin A RAE, and hence the corresponding Tagname was
    `VITA_RAEmg`, similarly "vitamin D" was `VITDEQmg`, according to
    DK19 documentation and FAO/INFOODS, 2012.

-   In NZ18, renaming was manually done. Information about Vit. D was
    insufficient to certainly know the Vit. D fraction reported in the
    FCT.

-   In the UK21, Tagnames were added manually. In addition, some things
    that were noted were: Alcohol was reported as volumen (Alcohol (ALC)
    g/ mL (w/v)). We did not transformed the units because: 1) alcohol
    was not included as one of the NVs to be reviewed and, 2) we finally
    did not include this FCT into the final Fishery Global NCT, 2022.
    However, for the future, if we want to change to match the 100g EP
    values, we could re-calculate ALC variable by using Eq.1 and the
    density of each food which is provided in the FCT
    (specific_gravity). Vitamin D was renamed to `VITDmg`, however
    re-calculation using D3 and 25-hydroxy D3 values would be
    recommended when possible. Finally, for the DHA and EPA, we used
    cis- version, but it should be reviewed. This was based on the
    documentation available in the Composition of Foods integrated
    dataset: PHE (Public Health England) (2021) Composition of foods
    integrated dataset (CoFID). Available at:
    <https://www.gov.uk/government/publications/composition-of-foods-integrated-dataset-cofid>
    (accessed 28/03/2022).

-   In the US19, renaming was also done manually and based on the
    documentation and the information provided in the Fisheries Global
    NCT, 2022. We identified the Tagnames in one of the attached files,
    hence for the future a comparison/ update using those Tagnames could
    be done.

-   In BA13 we renamed the variables to the Tagnames manually, Vitamin E
    (reported as "VITE") definition was not clear and hence, in future
    should be checked.

-   In NO21, variables were manually renamed to the Tagnames. This was
    included for this project hence a more in-depth review of each
    component was needed and it is described in the **Section X.X of the
    NO21 documentation**

#### 2.2. Other tidying operations

##### Removing parentheses and brackets <br>

In JA15, parentheses were used to denote "estimated values". According
to JA15 documentation, those were used to "Composition values estimated
based on values listed in the food composition tables of foreign
countries, raw material blending ratio recipe, etc. are indicated by
placing them in parentheses. For some of Cereals, Fruits and Mushrooms,
composition values derived from estimation or calculation using the
listed values of similar foods are indicated by placing them in
parentheses." (REF).

In KE18, brackets ("[]") denoting not preferred values, as for the KE18
reporting: "For alternative analytical method or lower quality. Data
from non-preferred Tagnames were presented only where preferred Tagnames
data was not available." (REF).

Bracket for low quality values were removed or generated a new column
with the alternative analytical method for UF16, WA19 and KE18. In
addition, for the later, a star ("\*") was used to identify items
fortified with folic acid. Note some issues on the reporting of this
fortification were found previously, however the data was not reviewed
in-depth because folate and derivates were outside the scope of this
work. When we removed the brackets, for future development accounting
for the impact of the "estimated values" should be studied.

##### Food groups <br>

Each FCT has its own food groups, for instance in some FCTs were useful
for identifying fishery and fishery products. For instance in UK21
fisheries were divided into five food groups: "White fish (JA)", "Fatty
fish (JC)", "Crustacea (JK)", "Molluscs (JM)", and "Fish products and
dishes (JR)". The id (`fcd_id`) could be used as well to identify as all
fisheries, as all started with "16".

### 3. Transforming values

##### 3.1. Characters in nutrient values <br>

Trace and/or below detection limit were reported and converted to zero
in the following FCTs: IN17 ("\<LOD"), BA13, BR11, JA15 ("Tr"), and
KE18, UK21, and WA19 ("tr").

Characters and symbols were used to report missing values were "nv" in
DK19, "-" in JA15, and "M" in NO21 which were all transformed to `NA`.

##### 3.2 & 3.3. Unit conversions and re-calculation <br>

Some components were reported in different units as those reported in
the Tagnames, hence unit conversion operations were performed. For
instance:

In the IN17, fatty acids needed to be converted from mg/100g EP to g/
100g EP, and amino acids from g/100g PROT to mg/100g EP (Eq.2.3).

Similarly, in JA15, we need to change the unit of the fatty acids from
mg to g, and the edible portion was calculated from refuse (Eq.3.1).

Moreover, when (substantial) changes, like those mentioned above, were
made to the values reported in the original FCT, documentation was done
on GitHub so future users could review our decisions:

Documentation in GitHub

[Issue\\#9](https://github.com/LuciaSegovia/UoN-FAO/issues/9),
[Issue\\#10](https://github.com/LuciaSegovia/UoN-FAO/issues/10).

#### 3.4. Combined variables (standardised) <br>

This was done after merging all the dataset together, and it's reported
on the `merging_all.R`.

Here's the list of the standardised variables as reported in the
Fisheries Global NCT, 2022, of which we only reported those in bold
(e.g., VITB6_mg_standardised, FAT_g\_standardised)

-   SOP_own = Sum of Proximate
-   ENERCkJ_standardised
-   ENERCkcal_standardised
-   CHOAVLDFg_standardised
-   **FAT_g\_standardised**
-   FIBTGg_standardised
-   VITAmcg_standardised
-   VITA_RAEmcg_standardised
-   CARTBEQmcg_standardised
-   VITEmg_standardised
-   THIAmg_standardised
-   FOLDFEmcg_standardised
-   **VITB6_mg_standardised**
-   **NIAEQmg_std**
-   NIAEQmg_standadised
-   NIATRIPmg_standardised
-   VITDmg_standardised

#### Updating the Global Fish NCT, 2022

##### 1. Merging all the data together <br>

Once the FCTs were loaded and harmonised, we combined them into a single
data file.

##### 2. Allocating the FAO codes: ISSCAAP, alpha-three, and ICS FAOSTAT.

Fish matching between FCTs fish entries and ICS FAOSTAT, alpha-three
code and ISSCAAP code was previously done in the Fishery Global NCT,
2022. Hence, we used that information to generate a dataset which
contained information for each fish entry about ISSCAAP, ICS FAOSTAT and
alpha-three codes ("ics-code_fish-code.csv"). The dataframe
`ics_code_file` contained the information in the following variables:
`ICS.FAOSTAT.SUA.Current.Code`, `source_fct`, `NDB_number`, `fdc_id`,
`Food.description`, `Scientific.name`, `ISSCAAP.Group`, and
`X3.alpha.code`.

Minor adjustment were needed, for instance, the food id of KE18 in the
Fishery Global NCT, 2022 were as in the "original" (raw) KE18 (e.g.,
"0807"). In order to match the KE18 ids. in our dataset, we removed the
first "0" (e.g., "807"). For the US19, we needed to change the `fdc_id`
to `NDB_number`. Then, we merged `ics_code_file` (the dataset derived
from Fishery Global NCT, 2022) and the newly Fisheries nutrient table
(`fish_fct`) by each fish entry id. (`fdc_id`). That operation resulted
in a dataset with all the fishery products and its corresponding ICS
FAOSTAT code, alpha-three code and ISSCAAP code.

The UK21 was excluded from the Fishery Global NCT, 2022 hence ICS
FAOSTAT code were not available for the fish in that FCT.

After all the merging operations, only fish with information on ICS code
were kept, hence, around 318 fish entries were filtered out, mainly from
UK21 but some from NO21 (see NO21_docu.R) as well

```{r, loading-data, include=FALSE}

source("merging_all.R")

fish_fct %>% filter(is.na(ICS.FAOSTAT.SUA.Current.Code)) %>% count(source_fct)

```

##### 3. Calculating the component values per ICS FAOSTAT fish category

After merging and filtering the fishes, and before calculating the
nutrient values of each ICS FAOSTAT fish category, we visualised the
data (e.g., data availability) and performed quality check for the
nutrient values of interest (Cu, I, Se, Niacin, Vit.B6, Vit. B12, Vit.
D, DHA, EPA). Visualisation scripts are reported in `visualisation.R`
and quality check are reported in `QC.R`.

###### 3.1. Data avaibility per each ICS FAOSTAT fish category

In figure 1, we can see that Cu and Vit. B6 was reported by all FCTs but
KE18, with overall very high data availability with very few missing
values. Vit. B6 was reported separated into three Tagnames. Most of the
FCTs used analytical values (`VITB6Amg`), followed by calculated
(`VITB6Cmg`) and only the NO21 used a mixed of values (`VITB6_mg`).
Then, as reported in section 3.4., the three variables were combined
into a new variable: `VITB6C_mg_standardised`.

Similarly, niacin (`NIAmg`) was reported in all FCTs but in WA19, in
which niacin equivalent (`NIAEQmg`) was reported. Because tryptophan was
reported in the WA19, `NIAmg` was re-calculated into a new variable
`NIAmg_std`.

I and Vit. D were reported only in six FCTs, and DHA and EPA were in
seven.

```{r, heat-map missing}

#├ Plot (heat map): % of missing values per FCT ----

components <- c( "WATERg", "F22D6N3g",
  "F20D5N3g",
  "VITB6Amg",
  "VITB6Cmg",
  "VITB6_mg",
#  "VITB6_mg_standardised",
  "NIAEQmg",
  "NIAmg",
  "NIATRPmg",
  "TRPmg",
  "VITB12mcg",
  "VITDEQmcg",
  "VITDmcg",
  "CHOCALmcg",
  "ERGCALmcg",
  "CHOCALOHmcg",
  "ERGCALOHmcg",
  "CUmg",
  "SEmcg",
  "IDmcg" )

fao_fish_fct %>% select(components, source_fct) %>% 
  naniar::gg_miss_fct(., fct = source_fct)

```

**Figure 1: Percentage of missing values per component and FCT**

We used figure 2 to identify those component that had more than 60% of
coverage across all the FCTs to be included in the expansion of the
Fisheries Global NCT, 2022.

```{r, bar-chart coverage, message=FALSE}

#├ Plot (bar chart): Coverage ----

fao_fish_fct %>% select(1:10, components) %>% 
  mutate_at(components, as.numeric) %>% 
  pivot_longer(cols = all_of(components),
               names_to = "NV", 
               values_to = "n") %>% 
  filter(!is.na(n)) %>% 
  group_by(NV) %>% 
  summarise(total = n()) %>%
  ungroup() %>% 
  mutate(perc = total/nrow(fao_fish_fct), 
         cat = ifelse(perc >.75, 
                      "high", 
                      ifelse(perc < 0.45, 
                             "poor", "medium" ))) %>% 
  ggplot(aes(x=reorder(NV, perc), y = perc*100, fill = as.factor(cat))) +
  geom_bar(stat = "identity") +
  theme_light() +
  coord_flip() +
  scale_fill_manual("Coverage",
  values=c("darkolivegreen3","lightgoldenrod2", "red4"), 
  labels = c("High (> 75%)", "Medium (75-45%)", "Poor (<45%)")) +
  theme(
    panel.grid.major.y = element_blank(),
    panel.border = element_blank(),
    axis.ticks.y = element_blank()) +
  labs( x= "", y= "", title = "Availability of data: Percentage (%) of fish entries with values of selected components")

```

**Figure 2: Coverage: Percentage of reported values per component**

**Table 3: Count of values per component and SUA fish category**

```{r, table data-available}

# 5) Table: Identifying missing values for each SUA fish category.

final_nv <-  c("WATERg"   ,   "F22D6N3g",     "F20D5N3g" , 
               "VITB6_mg_standardised", 
               "NIAmg","VITB12mcg" , "CUmg", "SEmcg")


##├ Table: Data available (count) per fish category and nutrient ----

x <- fao_fish_fct %>% select(-NDB_number) %>% 
  mutate_at(final_nv, as.numeric) %>% 
  group_by(ics_faostat_sua_english_description) %>% 
  summarise_if(is.numeric,  
               funs(
                    n = sum(!is.na(.)))) 

col_order <- sort(colnames(x), decreasing = T)

fao_fish_summary <- x[, col_order]


body_fct1 <- function(col, row){
  cells_body(
    columns = col,
    rows = {{row}} == 0
  )
}

body_fct2 <- function(col, row){
  cells_body(
    columns = col,
    rows = {{row}} == 1
  )
}


fao_fish_summary %>%
  select(ics_faostat_sua_english_description, ends_with("_n")) %>% 
  gt() %>% 
  tab_spanner(
    label = "Data available (count) per fish category and nutrient",
    columns = c(2:9)
  ) %>% 
  cols_label(
    ics_faostat_sua_english_description = "Fish categories",
    WATERg_n = "Water",
    VITB6_mg_standardised_n = "Vitamin B6",
    VITB12mcg_n = "Vitamin B12", 
    SEmcg_n = "Selenium", 
    NIAmg_n = "Niacin", 
    F22D6N3g_n = "DHA",
    F20D5N3g_n = "EPA", 
    CUmg_n = "Copper"
  ) %>%
  
  tab_style(
    style = list(
      cell_fill(color = scales::alpha("red", 0.7)),
      cell_text(color = "white", weight = "bold")
    ),
    locations = list(
      body_fct1(2, WATERg_n),
      body_fct1(3, VITB6_mg_standardised_n),
      body_fct1(4, VITB12mcg_n),
      body_fct1(5, SEmcg_n),
      body_fct1(6, NIAmg_n),
      body_fct1(7, F22D6N3g_n),
      body_fct1(8, F20D5N3g_n),
      body_fct1(9, CUmg_n)
    )) %>%
  tab_style(
    style = list(
      cell_fill(color = scales::alpha("yellow", 0.7)),
      cell_text(color = "black", weight = "bold")
    ),
    locations = list(
      body_fct2(2, WATERg_n),
      body_fct2(3, VITB6_mg_standardised_n),
      body_fct2(4, VITB12mcg_n),
      body_fct2(5, SEmcg_n),
      body_fct2(6, NIAmg_n),
      body_fct2(7, F22D6N3g_n),
      body_fct2(8, F20D5N3g_n),
      body_fct2(9, CUmg_n)
    )) %>%  
  tab_options(
    row_group.border.top.width = px(3),
    row_group.border.top.color = "black",
    row_group.border.bottom.color = "black",
    table.border.top.color = "white",
    table.border.top.width = px(3),
    table.border.bottom.color = "white",
    table.border.bottom.width = px(3),
    column_labels.border.bottom.color = "black",
    column_labels.border.bottom.width = px(2),
  )

  missing <- c("Cephalopods, cured", "Aquatic animals nei, cured", 
               "Aquatic animals nei, preparations nei", "Crustaceans, cured", 
               "Cephalopods, canned")

```

We highlighted in red when no values were reported for a component in a
SUA category and in yellow when less than three values were reported per
SUA category.

As shown in red in table 3, four SUA fish categories had no values for
Se concentration: `r toString(missing)`. Hence, we imputed some values
from other fish entries reported. The scripts that impute the values are
reported in `missing.R`, and the rationale is outline bellow.

For **Cephalopods, cured**, we used the water-adjusted Se mean
concentration of the items reported in table 4 to "complete" the Se
concentration of the following "Cephalopods, cured":

[1] "Mollusks, firefly squid, seasoned and smoked"\
[2] "Mollusks, processed squid,"Surume" dried squid"\
[3] "Mollusks, processed squid,"Saki-ika" dried, seasoned and shredded
squid"\
[4] "Mollusks, processed squid, seasoned and smoked"\

**Table 4**. Cephalopods used to impute Se values for "cephalopods,
cured"

| fcd_id | food_desc                                                      | WATERg | SEmcg | source_fct |
|--------------|-----------------|--------------|--------------|--------------|
| 10342  | Mollusks, neon flying squid, raw                               | 79.3   | 28    | JA15       |
| 10345  | Mollusks, Japanese common squid, raw "Syn. short-finned squid" | 80.2   | 41    | JA15       |

For **Cephalopods, canned**, there was only one item under that
category: *"Mollusks, Escargot Apple snails, canned in brine"*. However
that item should be recorded under "Molluscs, excluding cephalopods",
according to the description in the documentation (REF). Hence, to
populate this SUA category, we decided to use the cephalods entries from
"preparations nei", which were described as "boiled/ moist heat" (n=22)
(table 5). This was decided based on:

a)  The description of *Cephalopods, Canned* in the FAO documentation,
    which is \>"Raw or precooked meat from gutted or ungutted animals,
    canned in brine, oil or other medium (all edible) treated at
    temperatures adequate to ensure sterilization. Examples are:
    vacuum-packed small octopus, canned squid in own ink or oil.". \>

b)  Nutrient values reported on the Spanish FCT [ref] for "squids,
    fresh" and "squids, canned" were very similar. Unfortunately, there
    was no information for Se.

c)  Same fish type would have more similar composition, despite the
    cooking method, than a different fish, particularly when they are
    divided into distinct SUA categories.

d)  In addition, when perfect match is not possible the mean of several
    foods is recommended over a single food match (FAO/INFOODS, 2012).

**Table 5**: List of cephalopods imputed to generate the "Cephalopods,
canned" SUA category.

```{r, table cephalopods-boiled}

fao_fish_fct$WATERg <- as.numeric(fao_fish_fct$WATERg)
fao_fish_fct$SEmcg <- as.numeric(fao_fish_fct$SEmcg)

  fao_fish_fct %>% 
    filter(fish_type == "Cephalopods", 
           fish_prep %in% c("preparations nei"), 
           str_detect(food_desc, "boil|moist"), 
           #  source_fct == "JA15",
           !is.na(SEmcg)) %>%
    select(fdc_id,food_desc, WATERg,  SEmcg, source_fct) %>% 
 #   mutate_at(c("WATERg", "SEmcg"), as.numeric) %>% 
    mutate_if(is.numeric, ~round(., 2)) %>% 
    knitr::kable()

```

NOTE: There are some concerns related to the edible portion, for
instance in fish described as "canned", we are assuming that all content
is edible, and hence of the 100g of canned squid, X% would be squid and
Y% medium (e.g., sauce, oil, etc.). This is not captured by boiled which
is assuming 100% edible squid.

For **Aquatic animals, nei, cured and preparation nei**, when we checked
the items included in these two categories, there were mostly Sea
urchin, jellyfish, sea cucumber and sea squirt from the JA15.

However, when we reviewed the fish entries with Se values included in
the "Aquatic animals, nei, fresh" category, we realised that it was very
diverse category, including from crocodiles to sea cucumber. The only Se
information that was available and comparable was for sea cucumber, thus
we water-adjusted the Se concentration of: "Sea cucumber, raw" (`WATERg`
= 92.2, `SEmcg` = 37) for imputing the Se concentration in:

[1] "Sea cucumber,"Konowata" salted and fermented viscera"\
[2] "Sea urchin,"Tsubu-uni" salted whole gonads"\
[3] "Sea urchin,"Neri-uni" salted whole gonad paste"\
[4] "Jellyfish, Salted, desalted"\
[5] "Sea squirt,"Shiokara" salted and fermented meat and viscera (Syn.
Ascidian)"\

For **Crustaceans, cured**, we needed to impute Se concentration for
"Crustacean, Sakura shrimp, dried", for which we used (10415)
"Crustacean, whiteleg shrimp, raw" (`WATERg` = 78.60, `SEmcg` = 27).
And, for "Shrimp (crayfish), whole, dried", we calculated mean of the
values reported in table 6. These values were selected based on:

1)  They were the same fish item: Shrimp (crayfish).
2)  UF1(092004) value was reported in the references "Shrimp (crayfish),
    whole, dried".

**Table 6**: List of fish entries used to imputed to Se concentration
for "Shrimp (crayfish), whole, dried".

```{r, table crayfish-dried}

#id list
  crayfish <- fao_fish_fct %>% 
    filter(fish_type == "Crustaceans", 
           fish_prep == "fresh",
           source_fct == "UF16" ,
           !is.na(SEmcg),
           str_detect(food_desc, "crayfish|Crayfish" )) %>% pull(fdc_id)
  
  crayfish[4] <- "092004" #Adding this from the ref. list

  fao_fish_fct %>% 
    filter(fdc_id %in% crayfish) %>%
    select(fdc_id,food_desc, WATERg,  SEmcg, source_fct) %>% 
    mutate_at(c("WATERg", "SEmcg"), as.numeric) %>% 
    mutate_if(is.numeric, ~round(., 2)) %>% 
    distinct() %>% 
    knitr::kable()

```

Finally, values were not adjusted for any retaining factor as according
to Vásquez-Caicedo et al. (2008) and Bognar (2002), retention factors
for Se are between 0.9-1, with dry heat (braise, fry in oven, broiling,
grilling) being 1.

Information regarding the values used to impute/calculate the `SEmcg`
for the items can be found in the column `comment`.

###### 3.2. Data quality per each ICS FAOSTAT fish category

###### 1) Niacin

We check for "extreme values", and after plotting the values, we identified some potential "extreme values". However after comparing these values with similar fish product, all the values seemed plausible. For example, one of the
high value was smoke-dried and fermented fish (i.e., low water
concentration). When the niacin concentration was compared on dry-weight
basis concentration with similar fresh items, the niacin concentration
was similar.

Note that for "Other pelagic fish, cured", one of the high values had a
great influence in the final mean value. For instance, when we removed
values that were higher than 40mg/100g, the mean of that SUA category
was 15mg/100g instead of 30mg/100g (range:15-45mg/100g). This could be
solved by including more fish entries (more values) for that fish
category, as currently there are only two entries for that category.

The rest of the SUA categories remained more or less the same.

###### 2) Copper

Similarly for Cu, we identified items that had the highest values: Octopus from IN17 (fdc_id = R003) which looked very high, even when compared with other
octopus values. Double-check the value.

Oyster from UF16 (fdc_id = 093013) also seems high compared with other
oyster but seems plausible given the type of food. For instance, of the 10 items with the highest Cu concentration, 4 were oyster. 

Another item from the JA15 (fdc_id = 10350) was also extremely high,
however when we compared it with the "fresh" values, it was still in line
with the water content of that item. However, because the item was driving the very high mean for
the category "Cephalopods, cured", (mean = 
`r mean(as.numeric(fao_fish_fct$CUmg[fao_fish_fct$ics_faostat_sua_english_description == "Cephalopods, cured"]))`) we decided to remove it from the final mean, which yielded more nuanced value (mean = `r round(mean(as.numeric(fao_fish_fct$CUmg[fao_fish_fct$ics_faostat_sua_english_description == "Cephalopods, cured" & fao_fish_fct$fdc_id != "10350"])),2)`). For future, and in order to minimise the influence of this type of food items, more values should be sought for each category.

###### 3) Vitamin B6

Vitamin B6 was reported in all but one FCT (KE18). Overall, values were within plausible values. The highest values reported were for Tuna and they were still within normal ranges. 

###### 4) Vitamin B12

Vitamin B12 was reported in nine FCTs. JA15 seemed to report higher
values than the other FCTs, including most of the high-end values.

We found that "Molluscs, excluding cephalopods, frozen", "Molluscs,
excluding cephalopods, fresh", and "Molluscs, excluding cephalopods,
canned" had the highest Vit. B12 values. We found that clams from JA15
had the highest values for the "Molluscs, excluding cephalopods,
frozen". However, when we plotted the data it seemed to have a normal
distribution, and hence we are not considering them as outliers.

The category "Cephalopods, preparations nei" have very high variability,
it seemed that octopus had higher Vit.B12 than other cephalopods in the
category, also most of the high values were sourced from UF16, while the
highest was from US19. It maybe that the UF16 values were imputed from
US19.

###### 5) DHA

Of the seven FCTs that reported DHA, some "outliers" could be seen in
the US19 and DK19 with values higher than 5g of DHA.

When we checked for outliers, all the very high values (\>4g) were
reported in oils, hence they seemed plausible values. For the other
values higher than the Q4, most corresponded to fish and preparation
with high fat content (\>5%) (ref) and contained relatively low water
content (\<70%) (ref).

However when we checked the percentage of difference between fat content
of the items with DHA values and without, some concerning differences
were shown. This was particularly true for very heterogeneous SUA
categories were also limited number of items were included, for
instance, "Aquatic mammals, meat", "Aquatic animals nei, fresh". We
could not find values for DHA for those items in literature or other
FCTs, hence this remained as an area were improvements are needed.

"Aquatic plants, dried", there are many `NA`, however, for those that
values are available DHA is zero. Maybe we could "assume zero" for those
values.

###### 6) EPA

Results of the EPA checks were very similar to those for DHA.

###### 7) Selenium

When we checked the values one value, "Tuna, raw" (04.043) from the
NO21, seemed very high compared with other tuna values. There were other
high values but they seemed to be still within plausible ranges.

When we plotted the results by FCT, and by fish type we could see that
JA15 reported overall the highest Se median value with "extreme values",
coming consistently from that FCT, followed by NZ18. Some values of
those values are shown below.

`r subset(fao_fish_fct, fdc_id %in% c("T39", "04.043", "04.333", "04.107", "04.055"), select = c(fdc_id, food_desc, WATERg, SEmcg)) %>% knitr::kable(., digits=2)`

When we checked by SUA category, we identified the "Other pelagic fish, cured" which had the highest mean value,only two fish entries and only one Se value. Similarly, "Aquatic mammals, preparations nei" only reported information for three entries of which only two had a `SEmcg` value.

Again from the "Aquatic mammals, meat", we only have 3 values out of 15 values, which makes the mean quite high, although we can assess if that mean is high or is in line with the overall category mean due to the lack of data availability.

For future improvement, we could impute some values in order to smooth
the overall mean of this SUA categories.

###### Other components

Of the nutrients used to calculate energy, the most important for fish
and fish products are proteins, fat, water and ash. Hence, the review of
those components should be carried more in-depth than the other, as for
CHO, fibre, and alcohol could be assumed zero, for most of fish and
shellfish products, with the exceptions of preparations, fermented or
molluscs (FAO/INFOODS, 2012).

###### Proteins

###### Carbohydrates

-   Five FCTs/FCDBs did not report CHOAVLDFg
    (`r fao_fish_fct %>% filter(is.na(CHOAVLDFg)) %>% distinct(source_fct)`).
-   Of those, two reported CHOCDFg instead
    (`r fao_fish_fct %>% filter(is.na(CHOAVLDFg), !is.na(CHOCDFg))`)
-   Other two reported CHOAVLg
    (`r fao_fish_fct %>% filter(is.na(CHOAVLDFg), !is.na(CHOAVLg)) %>% count(source_fct)`).
-   IN17 did not reported content in CHO and fibre for fish and
    products. Although, it could be calculated as CHOAVLDFg, or we could
    also assumed to be zero.
-   CHOAVLMg and CHOCSMg could be removed from the final database as it
    is of no use and/or relevance for fishes.

###### Fat

In order to compare the DHA and EPA with the fat content, we needed to
combine several fat Tagnames. We combined those Tagnames into
`FAT_g_standardised` as reported in section 4.4. We checked the contribution from each of the fractions. 
`r fao_fish_fct %>% select(starts_with("FAT"), -FATRNg) %>% summarise_all(., ~sum(!is.na(.))/sum(!is.na(fao_fish_fct$FAT_g_standardised))*100) %>% round(.,2) %>% knitr::kable()`

###### Fibre

Fibre, crude (FIBCg) could be removed, it did not added information
on any missing (FBGTg). For the future development, check whether `NA`
    values for fibre could be assume equal to zero (see Next steps:
    Assumed zero section).

###### Alcohol

-   Ten FCTs/FCDBs did not report `ALCg`, of the three that did report it,
    the mean value was zero. For the future, we can hence assume alcohol
    = zero for fish and products.

### Final Quality Checks

Because this FCT is an extension of a existing FCT, we need to perform
some extra-control steps to ensure that values are a good representation
of the data shown. We also need to perform those extra steps as we have
added some new fish entries, and hence, we need to make sure that
reconciliation with all the other nutrients are performed.

#### Water content, protein, Ca, and Fe

We compared the values generated with the R scripts with the results that were generated and shared in excel file for a selection of components. We did that to ensure that the scripting approach was not introducing any systematic errors. Most of the values were identical or with minor variation that could fall within rounding differences. There were six SUA categories with "major" differences: "Marine fish nei, canned", "Aquatic animals nei, preparations nei", "Aquatic mammals, meat", "Marine fish nei, cured", "Freshwater & diadromous fish, fresh", "Freshwater & diadromous fish, frozen, whole". The source of differences were identified in consultation with the FAO team. The main source of discrepancies were typos or `NA` values being filled up. This was a great excersise as strengthen both approach helping to identify any potential mistakes in the final Fisheries Global NCT.  

#### DHA and EPA concentration

We calculated the mean and other summary statistics for the each fish
category, and only for the entries that reported the DHA and
EPA. This was done to evaluate the impact of missing values into the final
results.

We calculate the proportion of each fatty acid (DHA and EPA) to the total fat, for all the fish entries and only for those with complete values (i.e., reporting a value for `FAT_g_standardised`, `DHAg`, and `EPAg`). Then, we compare the difference between the two. Note that we used the `FAT_g_standardised` variable which is a
combination of the Tagnames (and different extractions): `FATg`,  `FAT_g`, and
`FATCEg`. The use of FATCE is not recommended for use in unit conversion
(FAO/INFOODS, 2012).However, as it is not going to be used to report values, and only for checking, we proceed to compare the percentage of each FA for the whole
dataset and only those entries with FA values.

Eq.: FA(%) = FAg/FATg x 100 , (F22D6N3g_perc =
F22D6N3g/FAT_g\_standardised\*100)

There were major differences between the two datasets, particularly for 16 SUAs categories that reported >10% difference in total fat between values with DHA and EPA and those without. The main reason were that those SUA category were were very broad, and hence the composition was highly variable. Also, the number of entries were very small as they were rare species (i.e., aquatic mammals, or aquatic plants). 

We also calculate the percentage of relative coverage (number of entries
reporting FAT_g\_standardised/ number of entries reporting the DHA/EPA
\*100). Thirty-one and thirty-two fish categories had lower than 60%
coverage for DHA and EPA respectively.

## Next steps: Functions development and improvemnts

#### Renaming variables

Overall - Allocate CDNO ontology codes to NV.

B13: - Get CARTBEQ or [CARTB] into two columns. - Remove function and
change to pre-loading functions from source(functions.R).

DK19 -Rename all other NV w/ Tagnames. -Find a better renaming way.

NZ18 -Rename all NV w/ Tagnames, including sugars and Fatty Acids.

US21 - Using data embeded in US21 to allocate the Tagnames for all NVs.

#### Characters in nutrient values

-   A function that generate different columns for different analytical
    method of the same/similar component. E.g., Extracting alternative
    analitycal method (i.e., NIA for Niacin) that are provided in the
    same column of the preferred analytical method (i.e., NIAEQ for
    Niacin) but within bracket.This type of data structure was observed in BA13, KE18, and WA19. 

-   A function that extract the "estimated" values and/or low quality
    values between brackets or parenthesis, and it generate a metadata
    info on that. Eg. A new column with a string providing information
    on which values were low quality and/or estimated. This was observed in JA15, where the use of bracket to denote "estimated values". We removed the brackets but we should look at how to keep a record and the meaning of estimated values. In KE18, "Low quality" values were reported within brackets.

-   A function to change Trace values, expressed as "tr", "Tr", "\<LOD",
    to 0 (zero).

UK21 - Check "N" values (found in Edible_portion)

#### Sum of proximate (SOP)

Sum of proximate (=$\sum$ of water + protein + fat + available
carbohydrates + dietary fibre + alcohol + ash)

Ranges: Preferable: 97 - 103 g (Greenfield and Southgate, 2003,
FAO/INFOODS, 2012)) Acceptable: 95 - 105 g (FAO/INFOODS, 2012))

#### Nutrient values

##### DHA and EPA

Fats and fatty acids concentration in fish and aquatic animals varies
widely. These components are very sensitive to many environmental,
seasonal and other changes. Hence, imputing missing values is not
optimal. Therefore, including more fishery entries with minimal missing
values should be sought in the future.

##### Energy

We will generate a function that will calculate energy in kcal and
energy in kj using the FAO conversion factors and the fao tagnames that
will be used to generate the columns: `ENERCkJ_standardized` and
`ENERCkcal_standardized` for the FAO fishery products database and for
MAPS to calculate energy used.

#### Carbohydrates available by difference (CHOAVLDF(g)\_standardized)

100 - (weight in grams [water + protein + fat + ash + alcohol + dietary
fibre] in 100 g of food)

#### Niacin Eq.

Total niacin equivalent (NIAEQ) = niacin preformed (NIA) + 1/60
tryptophan (TRP)

#### Unit conversion

Unit conversion (when possible) to match Tagnames (per 100g EP FW)

-   Alcohol(w/v) to (w/100g) = ALC (g/100mL) / density (g/mL) = ALC
    (g/100 EP)

###### Dealing with missing nutrient values

##### Assumed zero

-Fibre: We could check whether they are listed under fish or fish
preparations. If preparations then check what type of preparation,
otherwise we could assume zero. Current mean of FIBTGg =
`r round(fao_fish_fct %>% filter(!is.na(FIBTGg)) %>% pull(FIBTGg) %>% as.numeric() %>% mean(., na.rm = T), 2)`.

- Alcohol

- CHOAVLDF for non-processed foods. 

##### Imputing nutrient values

**Se concentration**: Mean mackerel fresh to (10157) (35055) with
(35164), by water-adjusting and assuming the oil has no contribution to
`Semcg`. Although, due to the low water content and overall high content
in Se of the category, it would only increase the mean. 
